# Лучшие практики написания комментариев к коду

[ Спасибо//]: # (https://habr.com/ru/users/AloneCoder/)

## Содержание

---

1. [Вступление](#вступление)
2. [Комментарии не должны дублировать код](#1-комментарии-не-должны-дублировать-код)
3. [Хорошие комментарии не оправдывают непонятный код](#2-хорошие-комментарии-не-оправдывают-непонятный-код)
4. [Если не можете написать понятный комментарий, то проблема может быть в коде](#3-если-не-можете-написать-понятный-комментарий-то-проблема-может-быть-в-коде)
5. [Комментарии должны исключать путаницу, а не вносить её](#4-комментарии-должны-исключать-путаницу-а-не-вносить-её)
6. [Объясняйте в комментариях не идиоматический код](#5-объясняйте-в-комментариях-не-идиоматический-код)
7. [Добавляйте ссылки на исходный код, который вы скопировали.](#6-добавляйте-ссылки-на-исходный-код-который-вы-скопировали)
8. [Добавляйте ссылки на внешние примеры в тех случаях, когда это полезнее всего](#7-добавляйте-ссылки-на-внешние-примеры-в-тех-случаях-когда-это-полезнее-всего)
9. [Справляя баги, добавляйте комментарии](#8-справляя-баги-добавляйте-комментарии)
10. [Помечайте комментариями незаконченные реализации](#9-помечайте-комментариями-незаконченные-реализации)
11. [Заключение](#заключение)

---

## Вступление

Как писал Питер Фогель:

- Написание и поддержка комментариев требует усилий.
- Ваш компилятор не смотрит на комментарии, поэтому невозможно определить их корректность.
- С другой стороны, вы гарантируете, что компьютер делает именно то, что предписывает ваш код.

Правила:

1. комментарии не должны дублировать код
2. хорошие комментарии не оправдывают непонятный код
3. если не можете написать понятный комментарий, то проблема может быть в коде
4. комментарии должны исключать путаницу, а не вносить её
5. объясняйте в комментариях не идиоматический код
6. добавляйте ссылки на исходный код, который вы скопировали.
7. добавляйте ссылки на внешние примеры в тех случаях, когда это полезнее всего
8. справляя баги, добавляйте комментарии
9. помечайте комментариями незаконченные реализации

Основные шаблоны:

```php
// NOTE: ... 
// ERROR: ...
// Example: ... пример
// Quirks: ... особенности

/* {{{ this stuff is against LeafPattern in the python version
* but it interferes with name() */
code ...
/* }}} */

 # could it be that something didn't match but changed l or c?
list ($matched, $l, $c) = $this->children[0]->match($l, $c);

// return min(outcomes, key=lambda outcome: len(outcome[1]))
 $min = null;
 
 // might be simply specified ambiguously 2+ times?
code ...

```

Основные описания ошибок и списком задач:

```php

// TODO(hal):  ...

# FIXME corner case "bla: options: --foo"

$result = $this->docopt("usage: prog [-o] <arg>\nOptions: -o", '-- -o'); # "--" is not allowed; FIXME?

/* @todo Handle default values */
```

## 1. Комментарии не должны дублировать код

Неинформативные комментарии вредны, потому что:

- вносят визуальный беспорядок;
- отнимают время на написание и чтение;
- могут устареть.

Классический плохой пример:

```php
i = i + 1; // Add one to i
```

## 2. Хорошие комментарии не оправдывают непонятный код

> «Не комментируйте плохой код, а переписывайте его» - Керниган и Плогер в книге "The Elements of Programming Style"

```php
private static Node getBestChildNode(Node node) {
    Node n; // best child node candidate
    for (Node node: node.getChildren()) {
        // update n if the current state is better
        if (n == null || utility(node) > utility(n)) {
            n = node;
        }
    }
    return n;
}
```

Комментарий был бы не нужен, если дать переменной правильное название:

```php
private static Node getBestChildNode(Node node) {
    Node bestNode;
    for (Node currentNode: node.getChildren()) {
        if (bestNode == null || utility(currentNode) > utility(bestNode)) {
            bestNode = currentNode;
        }
    }
    return bestNode;
}
```

## 3. Если не можете написать понятный комментарий, то проблема может быть в коде

> Самый известный комментарий в исходном коде Unix звучит так: «Вряд ли вы это поймёте» - Закон Кернигана

Отладка вдвое труднее первоначального написания кода. Поэтому если вы пишете код как можно умнее, то вы по определению
не настолько умны, чтобы его отладить.

## 4. Комментарии должны исключать путаницу, а не вносить её

> [Питер Самсон] особенно усложнял ситуацию тем, что отказывался добавлять в свой исходный код комментарии с пояснением,
> что он делает в каждом конкретном случае. Одна из распространённых программ, написанных Самсоном, состояла из сотен
> инструкций на ассемблере с единственным комментарием после инструкции под номером 1750. Комментарий был такой: RIPJSB,
> и
> люди ломали головы над тем, что это означает, пока кто-то не догадался, что в 1750-м году умер Бах, и что Самсон
> написал
> аббревиатуру фразы “Rest In Peace Johann Sebastian Bach”.

Хотя я ценю хороший хак, но это не пример для подражания. Если ваш комментарий вносит путаницу, а не устраняет, то
удалите его.

## 5. Объясняйте в комментариях не идиоматический код

```php
if (b == true)
```

Я удивился, почему бы не заменить его просто на if (b), как сделал бы это на Java. В результате небольшого исследования
я выяснил, что допускающие пустое значение булевы переменные явным образом сравниваются с true, чтобы избежать уродливой
проверки на null:

```php
if (b != null && b)
```

Я рекомендую **не добавлять** комментарии к распространённым идиомам, если только вы не пишете руководство для новичков.

## 6. Добавляйте ссылки на исходный код, который вы скопировали.

Если вы такой же, как и большинство программистов, то иногда вы используете найденный в сети код. Добавляйте ссылку на
исходник, чтобы будущие читатели имели полный контекст, например:

- какую задачу вы решали;
- кто предоставил код;
- почему это решение рекомендовано;
- что думали об этом комментаторы;
- работает ли это ещё;
- как его можно улучшить.

Посмотрите на такой комментарий:

```
/** Converts a Drawable to Bitmap. via https://stackoverflow.com/a/46018816/2219998. */
```

Если перейти по ссылке, то вы обнаружите, что:

- Автора кода зовут Tomáš Procházka, он входит в топ-3% на Stack Overflow.
- Один из комментаторов предложил улучшение, уже внесённое в репозиторий.
- Другой комментатор предложил способ избежать пограничного случая.

Некоторые программисты могут не захотеть указывать, что они не сами написали код, но повторное использование кода может
быть разумным шагом, экономящим время и дающим вам преимущество в виде большего количества проверяющих. Конечно, никогда
не вставляйте код, который не понимаете. Люди копируют со StackOverflow много кода, который попадает под лицензирование
Creative Commons, требующее указания авторства. Для этого достаточно указать ссылку на первоисточник.

Вы также можете ссылаться на оказавшиеся полезными руководства в качестве благодарности их авторам и ради экономии
времени читателей:

```
// Many thanks to Chris Veness at http://www.movable-type.co.uk/scripts/latlong.html
// for a great reference and examples.
```

## 7. Добавляйте ссылки на внешние примеры в тех случаях, когда это полезнее всего

Конечно, не все ссылки ведут на Stack Overflow.

```
// http://tools.ietf.org/html/rfc4180 suggests that CSV lines
// should be terminated by CRLF, hence the \r\n.
csvStringBuilder.append("\r\n");
```

Ссылки на стандарты и другую документацию помогут читателям понять проблему, которую решает ваш код. Хотя эта информация
может храниться в проектной документации, однако удачно размещённый комментарий станет своевременным указателем. В
приведённом примере ссылка подсказывает, что RFC 4180 обновили на RFC 7111, это полезная информация.

## 8. Справляя баги, добавляйте комментарии

Комментарии следует добавлять не только при первичном написании кода, но и при его изменении, особенно при исправлении
багов. Взгляните:

```
// NOTE: At least in Firefox 2, if the user drags outside of the browser window,
// mouse-move (and even mouse-down) events will not be received until
// the user drags back inside the window. A workaround for this issue
// exists in the implementation for onMouseLeave().
@Override
public void onMouseMove(Widget sender, int x, int y) { .. }
```

Комментарий не только помогает понять код в конкретных методах, но и определить, нужен ли ещё этот код и как его
тестировать. Также комментарий может ссылаться на систему отслеживания ошибок:

```
// Use the name as the title if the properties did not include one (issue #1425)
```

Конечно, можно с помощью git blame найти коммит, в котором была добавлена или изменена строка. Однако пояснения к
коммитам обычно краткие, и самые важные изменения (например, исправление бага №1425) могут не содержаться в последнем
коммите (который, скажем, переместил метод из одного файла в другой).

## 9. Помечайте комментариями незаконченные реализации

Иногда необходимо проверять код, даже несмотря на его ограничения. Хотя может быть заманчиво не рассказывать о
недостатках своего кода, лучше сделать это явно, например, в комментарии TODO:

```
// TODO(hal): We are making the decimal separator be a period,
// regardless of the locale of the phone. We need to think about
// how to allow comma as decimal separator, which will require
// updating number parsing and other places that transform numbers
// to strings, such as FormatAsDecimal
```

Стандартный формат для таких комментариев помогает оценить и адресовать технический долг. Ещё лучше, если добавите
задачу в систему отслеживания ошибок и вставите ссылку в комментарий.

## Заключение

> Джефф Этвуд, один из сооснователей Stack Overflow: «Код говорит вам «как», а комментарии говорят «почему»

[⏏ К содержанию](#содержание)